"use strict";var Site=Site||{};Site.CanvasManager=function(){var e=this;this.nebula,this.globe,this.bokeh,this.quakes,this.bigQuake,this.canvas,this.camera,this.background,this.globeForward,this.earthquakes,this.selectedQuake,this.infoAnim,this.infoTimeout;var t,a;this.init=function(){this.canvas=document.getElementById("terra-canvas"),this.camera=new GK.Camera(220,this.canvas.width/this.canvas.height,.1,1e3),window.gl=this.canvas.getContext("experimental-webgl",{antialias:!1,alpha:!1}),gl.viewport(0,0,this.canvas.width,this.canvas.height),gl.clearColor(.3,.5,.9,1),gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA),gl.enable(gl.DEPTH_TEST),gl.enable(gl.BLEND),this.globe=(new GK.PointGlobeDrawable).init(),this.nebula=(new GK.NebulaDrawable).init(),this.bokeh=(new GK.BokehDrawable).init(),this.ring=(new GK.RingDrawable).init(),this.background=(new GK.BackgroundDrawable).init(),this.quakes=(new GK.EarthquakeDrawable).init(),this.bigQuake=(new GK.BigQuakeDrawable).init(),this.requestAnimFrame(this.tick)},this.draw=function(i){gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT),a=2e-4*i,t=Math.sin(a);var n=e.globe.modelMatrix;mat4.identity(n),mat4.translate(n,n,[8,0,-500]),mat4.scale(n,n,[18,18,18]),mat4.rotateX(n,n,t),mat4.rotateY(n,n,a);var o=vec3.fromValues(0,0,0),r=vec3.fromValues(-.8,0,1);vec3.rotateX(r,r,o,-t),vec3.rotateY(r,r,o,-a),vec3.normalize(r,r),e.globeForward=r,n=e.ring.modelMatrix,mat4.identity(n),mat4.translate(n,n,[8.5,0,-500]),mat4.scale(n,n,[22,22,22]),mat4.rotateY(n,n,Math.PI/9),mat4.rotateX(n,n,-Math.PI/9),n=e.background.modelMatrix,mat4.identity(n),mat4.translate(n,n,[0,0,-22]);var s=Math.max(this.camera.vRatio,1);mat4.scale(n,n,[s,s,1]),n=e.nebula.modelMatrix,mat4.identity(n),mat4.translate(n,n,[1.8,0,-100]),mat4.scale(n,n,[7,7,7]),mat4.rotateX(n,n,t),mat4.rotateY(n,n,a),n=e.bokeh.modelMatrix,mat4.identity(n),mat4.translate(n,n,[1.5,-0,-90]),mat4.rotateX(n,n,t),mat4.rotateY(n,n,a),e.quakes.modelMatrix=mat4.clone(e.globe.modelMatrix),e.bigQuake.modelMatrix=mat4.clone(e.globe.modelMatrix),gl.depthMask(!1),gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA),e.background.draw(e.camera,i),e.nebula.draw(e.camera,i),gl.blendFunc(gl.SRC_ALPHA,gl.ONE),e.ring.draw(e.camera,i),e.globe.draw(e.camera,i),e.bokeh.draw(e.camera,i),e.quakes.draw(e.camera,i),Site.ww>703&&(e.bigQuake.draw(e.camera,i),e.updateSelectedQuake())},this.updateSelectedQuake=function(){if(this.selectedQuake){var t=mat4.create();mat4.multiply(t,e.camera.perspectiveMatrix,e.globe.modelMatrix);var a=vec3.clone(e.selectedQuake.pos),i=[0,e.canvas.height,e.canvas.width,-e.canvas.height];GK.ProjectionUtil.project(a,t,i)}},this.updateViewport=function(){gl.viewport(0,0,e.canvas.width,e.canvas.height),e.camera.vRatio=e.canvas.width/e.canvas.height,e.camera.update()},this.tick=function(t){e.requestAnimFrame(e.tick),e.draw(t)},this.pulse=function(t,a,i,n,o){var r=t||.1,s=a||.04,l=i||0,m=n||4;e.globe.ringWidth=r,e.globe.ringHeight=s,e.globe.ringVariety=l,e.globe.ringProgress=0,e.globe.ringEffectStr=0,o||(o=e.globeForward),e.globe.waveVector=o;var h=new Animation(m);h.updateFn=function(t){var a=BK.Ease.outSine(t);e.globe.ringProgress=2*a,e.globe.ringEffectStr=BK.Ease.smoothstep(0,.1,t)-BK.Ease.smoothstep(.8,1,t)},h.start()},this.quakesDidLoad=function(e){this.earthquakes=e,Site.canvasManager.quakes.createGeometry(e),Site.canvasManager.bigQuake.createGeometry(e[0])},this.quakePulse=function(){var t=e.getPertinentQuake(),a=vec3.clone(t.pos);vec3.normalize(a,a),e.bigQuake.createGeometry(t),e.selectedQuake=t,e.globe.waveEffectStr=0,e.globe.waveVector=a,e.globe.waveWidth=.1,e.globe.waveHeight=.005;var i=20*Site.ps,n=10*Site.ps-i;e.bigQuake.pointSize=i,e.bigQuake.progress=0,e.bigQuake.alpha=0,e.infoAnim&&e.infoAnim.stop(),e.infoAnim=new Animation(5),e.infoAnim.updateFn=function(t){var a=BK.Ease.outSine(BK.Ease.smoothstep(0,.2,t));e.bigQuake.progress=a,e.bigQuake.pointSize=i+n*a,e.bigQuake.alpha=BK.Ease.smoothstep(0,.1,t)-BK.Ease.smoothstep(.7,.8,t),e.globe.waveEffectStr=BK.Ease.smoothstep(0,.5,t)-BK.Ease.smoothstep(.5,1,t)},e.infoAnim.start(),e.infoTimeout=setTimeout(function(){e.pulse(.1,.04,0,3,a)},600)},this.dismissInfo=function(){e.infoAnim&&e.infoAnim.stop(),clearTimeout(e.infoTimeout)},this.getPertinentQuake=function(){for(var e=[],t=this.globeForward,a=0;a<this.earthquakes.length;a++){var i=this.earthquakes[a],n=vec3.dot(this.earthquakes[a].pos,t);e.push({quake:i,theta:n})}return e.sort(function(e,t){return t.theta-e.theta}),e[0].quake},this.earthquake=function(){var t=new Animation(4);t.updateFn=function(t){BK.Ease.inOutSine(t);e.globe.ringProgress=2*BK.Ease.inOutSine(GKEase.smoothstep(.2,1,t)),e.globe.ringEffectStr=1-BK.Ease.smoothstep(.2,.6,t),e.globe.waveEffectStr=BK.Ease.smoothstep(0,.1,t)-BK.Ease.smoothstep(.5,1,t)},t.start()},this.geometryLoaded=function(){e.ring.loadGeometry(this.geomLoader.models.ring),e.nebula.loadGeometry(this.geomLoader.models.nebula),e.globe.loadGeometry(this.geomLoader.models.globe)},this.requestAnimFrame=(window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame).bind(window)};